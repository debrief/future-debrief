#!/bin/bash
pnpm test

# Run fast pre-push validation showing detailed errors
echo "🚀 Running pre-push validation..."

FAILED=0
ORIGINAL_DIR=$(pwd)

# Find all Makefiles and run verify sequentially to show errors properly
# Store directories in a variable first to avoid subshell issues
MAKEFILE_DIRS=$(find . -path "*/*/Makefile" -not -path "*/node_modules/*" -exec dirname {} \;)

for dir in $MAKEFILE_DIRS; do
  cd "$dir" || continue
  pkg_name=$(basename "$(pwd)")
  echo "✅ Checking $pkg_name..."

  if ! make verify; then
    echo "❌ $pkg_name failed" >&2
    FAILED=1
  fi
  cd "$ORIGINAL_DIR" || exit 1
done

if [ "$FAILED" = "1" ]; then
  echo "❌ Some validations failed!" >&2
  exit 1
fi

echo "✅ All validations passed!"