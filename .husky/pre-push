#!/bin/bash
set -e  # Exit immediately on any error

pnpm test

# Run fast pre-push validation showing detailed errors
echo "🚀 Running pre-push validation..."

ORIGINAL_DIR=$(pwd)

# Check if web-components changed, and if so, build Storybook to catch runtime errors
if git diff --name-only main...HEAD 2>/dev/null | grep -q "^libs/web-components/"; then
  echo "✅ Checking Storybook build (web-components changed)..."
  pnpm --filter @debrief/web-components build-storybook --quiet || {
    echo "❌ Storybook build failed - check your story files for runtime errors" >&2
    exit 1
  }
fi

# Find all Makefiles and run verify sequentially to show errors properly
# Store directories in a variable first to avoid subshell issues
MAKEFILE_DIRS=$(find . -path "*/*/Makefile" -not -path "*/node_modules/*" -exec dirname {} \;)

for dir in $MAKEFILE_DIRS; do
  cd "$dir" || exit 1
  pkg_name=$(basename "$(pwd)")
  echo "✅ Checking $pkg_name..."

  # Fail immediately if make verify fails
  make verify || { echo "❌ $pkg_name verification failed" >&2; exit 1; }

  cd "$ORIGINAL_DIR" || exit 1
done

echo "✅ All validations passed!"