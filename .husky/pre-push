#!/bin/sh
set -e  # Exit immediately on any error

echo "⚡ Phase 1: Fast checks (typecheck, lint, artifacts)..."

ORIGINAL_DIR=$(pwd)

# Find all Makefiles and run fast verifications in parallel
MAKEFILE_DIRS=$(find . -path "*/*/Makefile" -not -path "*/node_modules/*" -exec dirname {} \;)

# Launch parallel verification tasks
FAILED=0
PIDS=""

for dir in $MAKEFILE_DIRS; do
  make -C "$dir" verify-artifacts verify-typecheck >/dev/null 2>&1 &
  PIDS="$PIDS $!"
done

# Wait for all parallel tasks to complete
for pid in $PIDS; do
  wait $pid || FAILED=1
done

# If any failed, re-run sequentially to show errors
if [ $FAILED -eq 1 ]; then
  echo "❌ Some checks failed. Re-running to show errors..." >&2
  echo "" >&2
  for dir in $MAKEFILE_DIRS; do
    pkg_name=$(basename "$dir")
    echo "Checking $pkg_name..." >&2
    if ! make -C "$dir" verify-artifacts verify-typecheck 2>&1; then
      echo "" >&2
    fi
  done
  exit 1
fi

echo "✅ Phase 1 complete"

# Phase 2: Tests (via turbo - runs once with caching)
echo "⚡ Phase 2: Running tests..."
NODE_NO_WARNINGS=1 pnpm test --output-logs=errors-only || {
  echo "❌ Tests failed" >&2
  exit 1
}
echo "✅ Phase 2 complete"

# Phase 3: Conditional Storybook build (only if web-components changed)
if git diff --name-only main...HEAD 2>/dev/null | grep -q "^libs/web-components/"; then
  echo "⚡ Phase 3: Storybook build (web-components changed)..."
  pnpm --filter @debrief/web-components build-storybook --quiet || {
    echo "❌ Storybook build failed" >&2
    exit 1
  }
  echo "✅ Phase 3 complete"
fi

echo "✅ All validations passed!"