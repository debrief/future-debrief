#!/bin/bash
set -e  # Exit immediately on any error

pnpm test

# Run fast pre-push validation showing detailed errors
echo "🚀 Running pre-push validation..."

ORIGINAL_DIR=$(pwd)

# Find all Makefiles and run verify sequentially to show errors properly
# Store directories in a variable first to avoid subshell issues
MAKEFILE_DIRS=$(find . -path "*/*/Makefile" -not -path "*/node_modules/*" -exec dirname {} \;)

for dir in $MAKEFILE_DIRS; do
  cd "$dir" || exit 1
  pkg_name=$(basename "$(pwd)")
  echo "✅ Checking $pkg_name..."

  # Fail immediately if make verify fails
  make verify || { echo "❌ $pkg_name verification failed" >&2; exit 1; }

  cd "$ORIGINAL_DIR" || exit 1
done

echo "✅ All validations passed!"