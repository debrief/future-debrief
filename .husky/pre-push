#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Run fast pre-push validation showing detailed errors
echo "ðŸš€ Running pre-push validation..."

temp_file=$(mktemp)

# Find all Makefiles and run verify sequentially to show errors properly
find . -path "*/*/Makefile" -not -path "*/node_modules/*" -exec dirname {} \; | while read dir; do
  cd "$dir"
  pkg_name=$(basename $(pwd))
  echo "âœ… $pkg_name"

  if ! make verify; then
    echo "âŒ $pkg_name failed" >&2
    echo "failed" > "$temp_file"
  fi
  cd - > /dev/null
done

if [ -f "$temp_file" ] && [ "$(cat "$temp_file")" = "failed" ]; then
  echo "âŒ Some validations failed!" >&2
  rm -f "$temp_file"
  exit 1
fi

rm -f "$temp_file"
echo "âœ… All validations passed!"