# VS Code Webview Content Security Policy (CSP)

This document explains a rendering issue that was caused by the Content Security Policy (CSP) of the VS Code extension's webview and how it was resolved.

## The Problem

A bug was reported where time markers on tracks in the plot editor were not being rendered correctly. The markers were supposed to be dynamically colored and rounded, but they were appearing as red squares. Further investigation revealed that after some changes, the markers were not appearing at all.

The issue was particularly confusing because the component responsible for rendering the markers (`Track.tsx`) worked correctly in Storybook, but not in the VS Code extension.

## The Diagnosis

The root cause of the problem was the Content Security Policy (CSP) of the VS Code webview. The `divIcon` in Leaflet was being used to create the markers, and its `html` property was being used to set inline styles for the `background-color`, `border`, and `border-radius`.

The CSP of the webview, which is defined in `apps/vs-code/src/providers/editors/plotJsonEditor.ts`, did not include the `'unsafe-inline'` directive for `style-src`. This meant that all inline styles were being blocked by the browser, which prevented the markers from being styled correctly.

This explained all the symptoms:
-   The markers were not styled correctly in the VS Code extension.
-   The markers were styled correctly in Storybook, which has a less restrictive CSP.
-   When the fallback CSS for the markers was removed, they disappeared entirely because the inline styles that gave them a size were also being blocked.

## The Solution

The solution was to modify the CSP in `plotJsonEditor.ts` to allow inline styles. The `style-src` directive was changed to include `'unsafe-inline'`.

**Before:**
```html
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${webview.cspSource} https://unpkg.com https://cdnjs.cloudflare.com; ...">
```

**After:**
```html
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${webview.cspSource} 'unsafe-inline' https://unpkg.com https://cdnjs.cloudflare.com; ...">
```

This change allows the inline styles to be applied, and the markers are now rendered correctly in the VS Code extension.

While `'unsafe-inline'` can be a security risk, it is acceptable in this case because the inline styles are generated by our own code and do not include any user-provided content.
