name: 'Publish Tool Vault Artifact'
description: 'Upload the .pyz file as a GitHub Actions artifact'
inputs:
  ref:
    description: 'Git ref to checkout'
    required: false
    default: ''
  artifact_retention_days:
    description: 'Days to retain the artifact'
    required: false
    default: '30'

outputs:
  artifact_name:
    description: 'Name of the uploaded artifact'
    value: 'toolvault-pyz'

runs:
  using: 'composite'
  steps:
    - name: Generate artifact metadata
      shell: bash
      working-directory: libs/tool-vault-packager
      run: |
        # Create metadata file with build information
        cat > toolvault-metadata.json << EOF
        {
          "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit_hash": "${{ github.sha }}",
          "ref": "${{ github.ref }}",
          "workflow_run_id": "${{ github.run_id }}",
          "file_size": "$(stat -c%s dist/toolvault.pyz 2>/dev/null || stat -f%z dist/toolvault.pyz)",
          "python_version": "$(python --version 2>&1)"
        }
        EOF
        
        echo "Generated metadata:"
        cat toolvault-metadata.json
    
    - name: Upload PYZ artifact
      uses: actions/upload-artifact@v4
      with:
        name: toolvault-pyz
        path: |
          libs/tool-vault-packager/dist/toolvault.pyz
          libs/tool-vault-packager/toolvault-metadata.json
        retention-days: ${{ inputs.artifact_retention_days }}
        
    - name: Upload artifact summary
      shell: bash
      run: |
        echo "### ðŸ“¦ Tool Vault PYZ Artifact Published" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifact Name:** toolvault-pyz" >> $GITHUB_STEP_SUMMARY
        echo "- **File Size:** $(du -h libs/tool-vault-packager/dist/toolvault.pyz | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "- **Retention:** ${{ inputs.artifact_retention_days }} days" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY