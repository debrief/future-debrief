name: 'Build Tool Vault SPA'
description: 'Build the Single Page Application for Tool Vault'
inputs:
  ref:
    description: 'Git ref to checkout'
    required: false
    default: ''

outputs:
  spa_path:
    description: 'Path to the built SPA'
    value: 'libs/tool-vault-packager/spa/dist'

runs:
  using: 'composite'
  steps:
    - name: Build SPA using npm
      shell: bash
      working-directory: libs/tool-vault-packager
      run: |
        echo "üîó Building SPA with npm..."
        echo "Working directory: $(pwd)"
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"

        if [ ! -f "shared-types/src/index.ts" ] || [ ! -d "shared-types/src/types" ]; then
          echo "‚ùå shared-types artifacts missing in libs/tool-vault-packager/shared-types"
          ls -R shared-types || true
          exit 1
        fi

        pushd spa >/dev/null
        npm install

        if [ ! -d "node_modules/@debrief/shared-types/src/types/tools" ]; then
          echo "‚ùå shared-types dependency not installed correctly in spa/node_modules"
          ls -R node_modules/@debrief || true
          exit 1
        fi

        if [ ! -f "node_modules/@debrief/shared-types/src/types/tools/tool.ts" ]; then
          echo "‚ùå Expected tool.ts in shared-types dependency, but it was not found"
          ls -R node_modules/@debrief/shared-types/src/types || true
          exit 1
        fi

        npm run verify-deps
        npm run build
        popd >/dev/null

        # Verify SPA was built
        if [ -d "spa/dist" ]; then
          echo "‚úÖ SPA built successfully"
          ls -la spa/dist/
        else
          echo "‚ùå SPA build failed"
          exit 1
        fi
