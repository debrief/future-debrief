name: 'Build Tool Vault SPA'
description: 'Build the Single Page Application for Tool Vault'
inputs:
  ref:
    description: 'Git ref to checkout'
    required: false
    default: ''

outputs:
  spa_path:
    description: 'Path to the built SPA'
    value: 'libs/tool-vault-packager/spa/dist'

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
    
    - name: Prepare dependencies for npm build
      shell: bash
      working-directory: libs/tool-vault-packager
      run: |
        echo "ğŸ”— Preparing dependencies for npm build..."
        echo "Working directory: $(pwd)"
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"

        # Prepare dependencies using symlinks (since pnpm already installed everything)
        npm run prepare-deps

        # Prepare SPA dependencies and modify package.json for npm compatibility
        cd spa
        npm run prepare-deps

        # Temporarily replace workspace: with file: for npm compatibility
        cp package.json package.json.bak
        sed 's|"workspace:\^1\.0\.0"|"file:../shared-types"|g' package.json.bak > package.json

        # Install using npm (should work now with file: paths)
        echo "ğŸ“¦ Installing SPA dependencies with npm..."
        npm install

        # Restore original package.json
        mv package.json.bak package.json
    
    - name: Build SPA
      shell: bash
      working-directory: libs/tool-vault-packager
      run: |
        npm run build:spa
        
        # Verify SPA was built
        if [ -d "spa/dist" ]; then
          echo "âœ… SPA built successfully"
          ls -la spa/dist/
        else
          echo "âŒ SPA build failed"
          exit 1
        fi