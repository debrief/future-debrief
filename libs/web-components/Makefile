# Makefile for @debrief/web-components
# Fast verification without rebuilding

# Colors for output
BLUE := \033[34m
GREEN := \033[32m
RED := \033[31m
RESET := \033[0m

# Source files to check
SRC_FILES := $(shell find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx")
NEWEST_SRC := $(shell ls -t $(SRC_FILES) | head -1)

# Build artifacts that should exist
DIST_FILES := dist/vanilla/index.js dist/vanilla/index.css dist/vanilla/vanilla-generated.d.ts

.PHONY: help verify verify-artifacts verify-tests verify-typecheck

help: ## Show this help message
	@echo "$(BLUE)@debrief/web-components - Fast Verification$(RESET)"
	@echo ""
	@echo "$(GREEN)Available targets:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(BLUE)%-15s$(RESET) %s\n", $$1, $$2}'

verify: verify-artifacts verify-tests verify-typecheck ## Fast verification (timestamp-based)
	@echo "$(GREEN)âœ… All web-components verifications passed!$(RESET)"

verify-artifacts: $(DIST_FILES) ## Verify build artifacts are up-to-date
	@echo "$(GREEN)âœ… All build artifacts are up-to-date$(RESET)"

verify-tests: ## Run tests without rebuilding
	@echo "$(BLUE)ğŸ§ª Running tests...$(RESET)"
	@pnpm test && echo "$(GREEN)âœ… Tests passed$(RESET)" || (echo "$(RED)âŒ Tests failed$(RESET)" >&2 && exit 1)

verify-typecheck: ## Type check without compilation
	@echo "$(BLUE)ğŸ” Type checking...$(RESET)"
	@pnpm typecheck && echo "$(GREEN)âœ… Type check passed$(RESET)" || (echo "$(RED)âŒ Type check failed$(RESET)" >&2 && exit 1)

# Build artifacts must be newer than source files
$(DIST_FILES): $(NEWEST_SRC)
	@if [ ! -f "$@" ]; then \
		echo "$(RED)âŒ [@debrief/web-components] Missing build artifact: $@$(RESET)"; \
		echo "$(BLUE)ğŸ’¡ Run: pnpm build$(RESET)"; \
		exit 1; \
	elif [ "$@" -ot "$(NEWEST_SRC)" ]; then \
		echo "$(RED)âŒ [@debrief/web-components] $@ is older than source files$(RESET)"; \
		echo "$(BLUE)ğŸ’¡ Newest source: $(NEWEST_SRC)$(RESET)"; \
		echo "$(BLUE)ğŸ’¡ Run: pnpm build$(RESET)"; \
		exit 1; \
	fi
