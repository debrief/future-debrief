name: Tool Vault PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
    paths:
      - 'libs/tool-vault-packager/**'

concurrency:
  group: toolvault-pr-preview-${{ github.event.number }}
  cancel-in-progress: true

jobs:
  pr-preview:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 1
    
    - name: Run Tool Vault PR Pipeline
      id: pipeline
      uses: ./libs/tool-vault-packager/CI/action/main-pipeline
      with:
        fly_api_token: ${{ secrets.FLY_API_TOKEN }}
        artifact_retention_days: '7'
        skip_deployment: ${{ secrets.FLY_API_TOKEN == '' }}
        is_pr: true
        pr_number: ${{ github.event.number }}
    
    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const commitSha = context.payload.pull_request.head.sha.substring(0, 7);
          
          // Check if deployment was skipped
          const skipDeployment = '${{ secrets.FLY_API_TOKEN }}' === '';
          const deploymentUrl = '${{ steps.pipeline.outputs.deployment_url }}';
          
          const comment = `
          ## ðŸ”§ Tool Vault Build Complete
          
          **Commit:** ${commitSha}
          **Artifact:** Available in Actions tab
          ${skipDeployment 
            ? '**Status:** Build and test completed (deployment skipped - no Fly.io credentials)'
            : deploymentUrl 
              ? `**Preview App:** ${deploymentUrl}`
              : '**Status:** Build completed (no deployment URL available)'
          }
          
          The Tool Vault packager has been built and tested successfully.
          `;
          
          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });